server {
    listen 80;
    server_name localhost;

    # CORS headers
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods 'GET, HEAD, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'Range,Content-Type' always;

    # VOD settings
    vod_mode local;
    vod_last_modified_types *;
    vod_expires 100d;

    # HLS master playlist and all variants/segments
    location ~ ^/hls/([0-9]+)/ {
        set $video_id $1;

        vod hls;
        alias /opt/static/videos/$video_id/video_720p.mp4;

        vod_hls_absolute_master_urls off;
        vod_hls_absolute_index_urls off;

        vod_align_segments_to_key_frames on;
        vod_output_buffer_pool 64k 32;
    }


    # VTT subtitles
    location ~ ^/subtitles/([0-9]+)/(.+\.vtt)$ {
        alias /opt/static/videos/$1/$2;
        add_header Content-Type text/vtt;
        add_header Access-Control-Allow-Origin *;
    }

    # Thumbnails
    location ~ ^/thumbnails/([0-9]+)/thumbnail\.jpg$ {
        alias /opt/static/videos/$1/thumbnail.jpg;
        add_header Content-Type image/jpeg;
        add_header Access-Control-Allow-Origin *;
    }

    # Health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
